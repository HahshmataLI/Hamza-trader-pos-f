<div class="space-y-6 p-4">
  <!-- Header Section -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-800 rounded-2xl p-6 text-white">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold mb-2">
          {{ isEditMode() ? 'Edit Product' : 'Create New Product' }}
        </h1>
        <p class="text-blue-100">
          {{ isEditMode() ? 'Update your product details and inventory' : 'Add new products to your inventory' }}
        </p>
      </div>
      <div class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center">
        <span class="text-2xl">ðŸ“¦</span>
      </div>
    </div>
  </div>

  <!-- Main Form -->
  <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="w-full">
    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
      <!-- Main Form Content -->
      <div class="xl:col-span-2 space-y-6">
        <!-- Basic Information Card -->
        <p-card header="Basic Information" class="shadow-lg border-0 w-full">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <!-- Product Name -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Product Name <span class="text-red-500">*</span>
              </label>
              <input 
                type="text" 
                pInputText 
                formControlName="name"
                placeholder="e.g., iPhone 15 Pro, Nike Air Max"
                class="w-full"
              />
              @if (productForm.get('name')?.invalid && productForm.get('name')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Product name is required
                </small>
              }
            </div>

            <!-- SKU -->
            <div class="space-y-2">
              <div class="flex items-center justify-between">
                <label class="block text-sm font-semibold text-gray-700">
                  SKU <span class="text-red-500">*</span>
                </label>
                @if (!isEditMode()) {
                  <div class="flex items-center space-x-2">
                    <p-inputSwitch 
                      [(ngModel)]="autoGenerateSku"
                      (onChange)="toggleSkuGeneration()"
                      [ngModelOptions]="{standalone: true}"
                    />
                    <span class="text-sm text-gray-600">Auto-generate</span>
                  </div>
                }
              </div>
              
              <input 
                type="text" 
                pInputText 
                formControlName="sku"
                placeholder="e.g., IP15-PRO-256"
                class="w-full"
                [readonly]="autoGenerateSku() && !isEditMode()"
              />
              
              <!-- SKU Suggestions -->
              @if (autoGenerateSku() && skuSuggestions().length > 0 && !isEditMode()) {
                <div class="space-y-2 mt-2">
                  <p class="text-sm text-gray-600">Suggestions:</p>
                  <div class="flex flex-wrap gap-2">
                    @for (suggestion of skuSuggestions(); track suggestion) {
                      <p-tag 
                        [value]="suggestion" 
                        severity="info"
                        styleClass="cursor-pointer"
                        (click)="onSkuSuggestionSelect(suggestion)"
                      />
                    }
                  </div>
                </div>
              }
              
              @if (productForm.get('sku')?.invalid && productForm.get('sku')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  SKU is required
                </small>
              }
            </div>

            <!-- Category -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Category <span class="text-red-500">*</span>
              </label>
              <p-select
                formControlName="category"
                [options]="categoryOptions()"
                placeholder="Select category"
                class="w-full"
                optionLabel="label"
                optionValue="value"
                (onChange)="onCategoryChange()"
              />
              @if (productForm.get('category')?.invalid && productForm.get('category')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Category is required
                </small>
              }
            </div>

            <!-- Barcode -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">Barcode</label>
              <input 
                type="text" 
                pInputText 
                formControlName="barcode"
                placeholder="e.g., 123456789012"
                class="w-full"
              />
            </div>

            <!-- Description -->
            <div class="lg:col-span-2 space-y-2">
              <label class="block text-sm font-semibold text-gray-700">Description</label>
              <textarea 
                pInputTextarea 
                formControlName="description"
                placeholder="Describe this product..."
                [rows]="4"
                class="w-full resize-none"
              ></textarea>
            </div>
          </div>
        </p-card>

        <!-- Pricing Information -->
        <p-card header="Pricing & Inventory" class="shadow-lg border-0 w-full">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Cost Price -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Cost Price <span class="text-red-500">*</span>
              </label>
              <p-inputNumber
                formControlName="costPrice"
                mode="currency"
                currency="USD"
                locale="en-US"
                class="w-full"
                [min]="0.01"
              />
              @if (productForm.get('costPrice')?.invalid && productForm.get('costPrice')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Cost price is required
                </small>
              }
            </div>

            <!-- MRP -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                MRP <span class="text-red-500">*</span>
              </label>
              <p-inputNumber
                formControlName="mrp"
                mode="currency"
                currency="USD"
                locale="en-US"
                class="w-full"
                [min]="0.01"
              />
              @if (productForm.get('mrp')?.invalid && productForm.get('mrp')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  MRP is required
                </small>
              }
            </div>

            <!-- Minimum Sale Price -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Min Sale Price <span class="text-red-500">*</span>
              </label>
              <p-inputNumber
                formControlName="minSalePrice"
                mode="currency"
                currency="USD"
                locale="en-US"
                class="w-full"
                [min]="0.01"
              />
              @if (productForm.get('minSalePrice')?.invalid && productForm.get('minSalePrice')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Minimum sale price is required
                </small>
              }
            </div>

            <!-- Stock -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Stock <span class="text-red-500">*</span>
              </label>
              <p-inputNumber
                formControlName="stock"
                [min]="0"
                class="w-full"
              />
              @if (productForm.get('stock')?.invalid && productForm.get('stock')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Stock is required
                </small>
              }
            </div>

            <!-- Min Stock Level -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">
                Min Stock Level <span class="text-red-500">*</span>
              </label>
              <p-inputNumber
                formControlName="minStockLevel"
                [min]="0"
                class="w-full"
              />
              @if (productForm.get('minStockLevel')?.invalid && productForm.get('minStockLevel')?.touched) {
                <small class="text-red-500 block text-sm mt-1">
                  Minimum stock level is required
                </small>
              }
            </div>

            <!-- Status -->
            <div class="space-y-2">
              <label class="block text-sm font-semibold text-gray-700">Status</label>
              <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                <p-inputSwitch formControlName="isActive" />
                <span class="text-sm text-gray-700">
                  {{ productForm.get('isActive')?.value ? 'Active' : 'Inactive' }}
                </span>
              </div>
            </div>
          </div>
        </p-card>

        <!-- Category Attributes -->
        @if (allCategoryAttributes().length > 0) {
          <p-card header="Product Attributes" class="shadow-lg border-0 w-full">
            <div class="space-y-4">
              <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                  <span class="text-blue-600 text-lg mt-1">ðŸ’¡</span>
                  <div>
                    <p class="font-medium text-blue-900">Category Attributes</p>
                    <p class="text-sm text-blue-700 mt-1">
                      These attributes are defined by the selected category. Required fields are marked with *.
                    </p>
                  </div>
                </div>
              </div>

              <div *ngIf="productForm.get('attributes')" formGroupName="attributes" class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                @for (attribute of allCategoryAttributes(); track attribute.name) {
                  <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700">
                      {{ attribute.label || attribute.name }}
                      @if (attribute.required) {
                        <span class="text-red-500">*</span>
                      }
                    </label>

                    @switch (attribute.type) {
                      @case ('text') {
                        <input 
                          type="text"
                          pInputText
                          [formControlName]="attribute.name"
                          [placeholder]="'Enter ' + (attribute.label || attribute.name)"
                          class="w-full"
                        />
                      }
                      @case ('number') {
                        <p-inputNumber
                          [formControlName]="attribute.name"
                          [placeholder]="'Enter ' + (attribute.label || attribute.name)"
                          class="w-full"
                        />
                      }
                      @case ('select') {
                        <p-select
                          [formControlName]="attribute.name"
                          [options]="getAttributeOptions(attribute)"
                          [placeholder]="'Select ' + (attribute.label || attribute.name)"
                          class="w-full"
                        />
                      }
                      @case ('boolean') {
                        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded-lg">
                          <p-inputSwitch [formControlName]="attribute.name" />
                          <span class="text-sm text-gray-700">
                            {{ productForm.get('attributes.' + attribute.name)?.value ? 'Yes' : 'No' }}
                          </span>
                        </div>
                      }
                    }
                    
                    @if (productForm.get('attributes.' + attribute.name)?.invalid && 
                         productForm.get('attributes.' + attribute.name)?.touched && 
                         attribute.required) {
                      <small class="text-red-500 block text-sm">
                        {{ attribute.label || attribute.name }} is required
                      </small>
                    }
                  </div>
                }
              </div>
            </div>
          </p-card>
        }
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        <!-- Image Upload -->
        <p-card header="Product Images" class="shadow-lg border-0">
          <div class="space-y-4">
            <p-fileUpload
              mode="basic"
              chooseLabel="Choose Images"
              [multiple]="true"
              accept="image/*"
              [maxFileSize]="1000000"
              (onSelect)="onImageSelect($event)"
              styleClass="w-full"
            />
            
            <div class="grid grid-cols-2 gap-2">
              @for (image of productForm.get('images')?.value; track $index) {
                <div class="relative group">
                  <img 
                    [src]="image" 
                    alt="Product image"
                    class="w-full h-20 object-cover rounded-lg"
                  />
                  <button
                    type="button"
                    class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
                    (click)="removeImage($index)"
                  >
                    Ã—
                  </button>
                </div>
              }
            </div>
          </div>
        </p-card>

        <!-- Quick Stats -->
        <p-card header="Quick Stats" class="shadow-lg border-0">
          <div class="space-y-3">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <span class="text-gray-600">Profit Margin</span>
              <span 
                class="font-bold"
                [class.text-green-600]="getProfitMargin() > 0"
                [class.text-red-600]="getProfitMargin() <= 0"
              >
                {{ getProfitMargin() }}%
              </span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <span class="text-gray-600">Stock Status</span>
              <span 
                class="font-bold px-2 py-1 rounded text-xs"
                [class]="getStockStatusClass()"
              >
                {{ getStockStatus() }}
              </span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <span class="text-gray-600">Required Attributes</span>
              <span class="font-bold text-blue-600">
                {{ getRequiredAttributesCount() }}/{{ getRequiredAttributesTotal() }}
              </span>
            </div>
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <span class="text-gray-600">Form Status</span>
              <span 
                class="font-bold px-2 py-1 rounded text-xs"
                [class]="isFormValid() ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
              >
                {{ isFormValid() ? 'Valid' : 'Invalid' }}
              </span>
            </div>
          </div>
        </p-card>

        <!-- Form Actions -->
        <p-card header="Actions" class="shadow-lg border-0 sticky top-6">
          <div class="space-y-3">
            <button 
              type="submit"
              pButton 
              label="{{ isEditMode() ? 'Update Product' : 'Create Product' }}" 
              icon="pi pi-check"
              styleClass="w-full"
              [loading]="loading()"
              [disabled]="!isFormValid() || loading()"
            ></button>
            
            <button 
              type="button"
              pButton 
              label="Cancel" 
              icon="pi pi-times"
              severity="secondary" 
              [outlined]="true"
              styleClass="w-full"
              routerLink="/products"
            ></button>
            
            @if (isEditMode()) {
              <p-divider />
              <button 
                type="button"
                pButton 
                label="Delete Product" 
                icon="pi pi-trash"
                severity="danger" 
                [outlined]="true"
                styleClass="w-full"
                (click)="confirmDelete()"
              ></button>
            }
          </div>
        </p-card>
      </div>
    </div>
  </form>

  <!-- Error Message -->
  @if (error()) {
    <p-message severity="error" class="w-full">
      <div class="flex items-center space-x-3">
        <i class="pi pi-exclamation-triangle"></i>
        <div>
          <p class="font-medium">Error</p>
          <p>{{ error() }}</p>
        </div>
      </div>
    </p-message>
  }
</div>

<p-toast />
<p-confirmDialog />